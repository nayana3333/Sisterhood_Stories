{% extends "base.html" %}
{% load static %}
{% block title %}Book Appointment - {{ psychiatrist.full_name }}{% endblock %}

{% block extra_head %}
<style>
  body {
    background: #FFF4F7;
  }
  
  .booking-container {
    max-width: 800px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .booking-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(244, 166, 181, 0.12);
    padding: 32px;
  }
  
  .doctor-header {
    display: flex;
    align-items: center;
    gap: 20px;
    padding-bottom: 24px;
    border-bottom: 2px solid #f0f0f0;
    margin-bottom: 24px;
  }
  
  .doctor-photo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #F4A6B5;
  }
  
  .doctor-info h2 {
    margin: 0 0 8px;
    color: #333;
    font-size: 24px;
  }
  
  .doctor-info .specialization {
    color: #666;
    font-size: 14px;
    margin-bottom: 4px;
  }
  
  .rating {
    color: #F4B400;
    font-size: 18px;
  }
  
  .form-section {
    margin-bottom: 24px;
  }
  
  .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    display: block;
    font-size: 14px;
  }
  
  .form-control, .form-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid rgba(244, 166, 181, 0.3);
    border-radius: 12px;
    font-size: 14px;
    font-family: 'Poppins', sans-serif;
    transition: all 0.2s ease;
    box-sizing: border-box;
  }
  
  .form-control:focus, .form-select:focus {
    outline: none;
    border-color: #F4A6B5;
    box-shadow: 0 0 0 3px rgba(244, 166, 181, 0.1);
  }
  
  .slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }
  
  .slot-item {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
    text-align: center;
  }
  
  .slot-item:hover:not(.booked) {
    background: #FFF5F9;
    border-color: #F4A6B5;
  }
  
  .slot-item.selected {
    background: #FFF5F9;
    border-color: #F4A6B5;
    font-weight: 600;
    color: #F88379;
  }
  
  .slot-item.booked {
    opacity: 0.5;
    cursor: not-allowed;
    background: #e9ecef;
  }
  
  .submit-btn {
    width: 100%;
    background: linear-gradient(135deg, #F88379, #F4A6B5);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 14px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 8px;
  }
  
  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(244, 166, 181, 0.3);
  }
  
  .submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .form-check {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }
  
  .form-check input {
    width: auto;
    cursor: pointer;
  }
  
  .form-check label {
    font-size: 14px;
    color: #333;
    cursor: pointer;
    margin: 0;
  }
  
  @media (max-width: 768px) {
    .booking-container {
      padding: 0 16px;
    }
    
    .booking-card {
      padding: 24px;
    }
    
    .doctor-header {
      flex-direction: column;
      text-align: center;
    }
    
    .slots-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="booking-container">
  <div class="booking-card">
    <div class="doctor-header">
      {% if psychiatrist.photo %}
        <img class="doctor-photo" src="{{ psychiatrist.photo.url }}" alt="{{ psychiatrist.full_name }}" />
      {% else %}
        <img class="doctor-photo" src="https://randomuser.me/api/portraits/women/81.jpg" alt="{{ psychiatrist.full_name }}" />
      {% endif %}
      <div class="doctor-info">
        <h2>{{ psychiatrist.full_name }}</h2>
        <div class="specialization">{{ psychiatrist.specialization|default:"General Psychiatry" }} • {{ psychiatrist.years_experience }} years experience</div>
        <div class="rating">
          {% if psychiatrist.rating %}
            {% for i in "12345" %}
              {% if forloop.counter <= psychiatrist.rating|floatformat:0|add:"0"|make_list|first|add:"0" %}
                ★
              {% else %}
                ☆
              {% endif %}
            {% endfor %}
            ({{ psychiatrist.rating|floatformat:1 }})
          {% else %}
            ★★★★★ (New)
          {% endif %}
        </div>
      </div>
    </div>
    
    <form method="post" id="bookingForm">
      {% csrf_token %}
      
      <div class="form-section">
        <label class="form-label">Select Available Time Slot</label>
        {% if available_slots %}
          <div class="slots-grid" id="slotsGrid">
            {% for slot in available_slots %}
            <div class="slot-item" data-slot-id="{{ slot.id }}" onclick="selectSlot({{ slot.id }})">
              <div style="font-weight: 600;">{{ slot.start|date:"M d" }}</div>
              <div style="font-size: 13px; color: #666;">{{ slot.start|date:"g:i A" }} - {{ slot.end|date:"g:i A" }}</div>
            </div>
            {% endfor %}
          </div>
          <input type="hidden" name="slot_id" id="selectedSlotId" required>
        {% else %}
          <div style="padding: 20px; background: #fff3cd; border-radius: 12px; color: #856404;">
            No available slots at the moment. Please check back later or contact the psychiatrist directly.
          </div>
        {% endif %}
      </div>
      
      <div class="form-section">
        <label class="form-label">Session Mode</label>
        {{ form.mode }}
        {% if form.mode.errors %}
          <div style="color: #dc3545; font-size: 13px; margin-top: 4px;">{{ form.mode.errors }}</div>
        {% endif %}
      </div>
      
      <div class="form-section">
        <div class="form-check">
          {{ form.allow_anonymous }}
          <label for="{{ form.allow_anonymous.id_for_label }}">Book anonymously</label>
        </div>
        <div id="pseudonymGroup" style="display: none; margin-top: 12px;">
          <input type="text" name="pseudonym" class="form-control" placeholder="Display name (optional)" maxlength="80">
        </div>
      </div>
      
      <div class="form-section">
        <label class="form-label">Notes (Optional)</label>
        {{ form.notes }}
        {% if form.notes.errors %}
          <div style="color: #dc3545; font-size: 13px; margin-top: 4px;">{{ form.notes.errors }}</div>
        {% endif %}
      </div>
      
      {% if form.non_field_errors %}
        <div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
          {{ form.non_field_errors }}
        </div>
      {% endif %}
      
      <button type="submit" class="submit-btn" id="submitBtn" {% if not available_slots %}disabled{% endif %}>
        Confirm Booking
      </button>
    </form>
  </div>
</div>

<script>
let selectedSlotId = null;

function selectSlot(slotId) {
  selectedSlotId = slotId;
  document.getElementById('selectedSlotId').value = slotId;
  
  // Update UI
  document.querySelectorAll('.slot-item').forEach(item => {
    item.classList.remove('selected');
  });
  document.querySelector(`[data-slot-id="${slotId}"]`).classList.add('selected');
  
  document.getElementById('submitBtn').disabled = false;
}

// Toggle pseudonym field
document.getElementById('{{ form.allow_anonymous.id_for_label }}')?.addEventListener('change', function() {
  const group = document.getElementById('pseudonymGroup');
  if (this.checked) {
    group.style.display = 'block';
  } else {
    group.style.display = 'none';
    group.querySelector('input').value = '';
  }
});
</script>
{% endblock %}

